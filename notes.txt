NOVA 2018
~~~

#noteletext #justrasters
Maybe a demo for NOVA 2018 :)

Have <=10 weeks in theory until 23 June 2018
Bound to lose some of these to work & RL etc.
Need to commit to doing this by April 28 (2 weeks)
Aim to complete the demo by May 9 (6 weeks)
Giving 2 weeks buffer and chance to test etc.

Obvious place to start is raster timed FX from last year
Would like to do 3D (especially w/ co-pro) but not enough
time to explore this properly (save to next year)

Have some FX already written (many not seen on Beeb before):
1/ Kefrens bars
2/ Parallax bars
3/ Horizontal bars
4/ Twister

Additional FX that could be "quickly" written in theory:
5/ Checkboard zoom or wibble
6/ Static text/image raster stretch (32x32)
7/ Raster scrolltext?

Theme could be #noteletext to riff on idea that Beeb
can only do Teletext FX.

So start with Teletext as per Teletextr then switch
to raster FX. #justrasters

As always, keep it snappy so each FX just 30 seconds
ideally with 3x variations on the FX for 10 seconds each
Need some quick & easy way of intro'ing each part

- 20s (max) #noteletext #justrasters intro
- 30s for each FX x4-6
- 20s (max) outro & credits

Aim for 3m30s maximum :)

Assume Master only so can use SWRAM and SHADOW
As per Teletextr, preload all FX into SWRAM first
Don't forget we now understand ANDY & HAZEL better!

TO DO to get to commitment
~~~
1. Need to prove enough time to run music w/out events - DONE
    - Hack vgmplayer into Kefrens bars in our vsync

2. Need to be able to switch between FX - DONE
    - Simple framework for sequencing the parts - DONE
      Do vsync in main loop and call render fn in FX module
      Main loop also resets CRTC cycle to standard values?

    - Initialise fn for setting up frame buffers before FX - DONE
      Use pucrunch to decompress from SWRAM? (Size check!)
      How to keep the music going between FX here? (Figure out later)

    - Frame counter in main loop to control sequence - DONE
      Kill previous FX module (is kill fn needed?)
      Initialise new FX module (before first tick)
      Switch FX params (or trigger next variation)

To complete the demo
~~~
1. Each FX needs to look a lot nicer!
2. Each FX needs 3x variants (ideally)
3. Need custom music from IP
4. Need intro (w/ Teletext?)
5. Need outro (w/ Teletext?)
6. Need some way of introducing the parts
7. Timing & polish

What is the most impressive FX to finish on?!?


TO DO
~~~
. Move music out of Core RAM - put in SWRAM for now (leave ANDY & HAZEL?) - DONE
. Move Kefrens module to SWRAM - leave expanded codegen to begin with - DONE
. Port another FX module into framework - Twister? - DONE
. System for switching between FX - leave music broken for now! - DONE
. Establish what the default machine state is between FX - DONE
  . what can be assumed and doesn't need to be initialised
  . and what needs to be put back on FX kill
  . fix crud left on screen by Parallax etc.
. Come up with standard approach to hiding any CRTC glitches during FX init - DONE
  . blank screen with CRTC registers going to be tough as part of setup!
  . display blank SHADOW screen - what if FX needs to copy to SHADOW?
  . use palette to blackout?
. Check timing of ULA palette switch in rotbox - DONE
  . should we move to scanline -1 start (or just hblank?)
. Check SHADOW RAM usage in Parallax - DONE
  . what ACCON state should be expected between FX?

. Fix audio glitch during long init - see following
. Decompress screen data from SWRAM - preconvert Twister & Parallax to 
. Decompress generated code from SWRAM - establish guaranteed space in CORE
  
For switching between FX it's probably OK to reenable interupts & run the vgm_player
on an event. Just need to re-vsync after initialising the next part - DONE
-> or actually, make init fn responsible for polling music player after vsyncs
can provide standard memory move and or decompress fns with this included - TODO

OK, propose that initialisation expectation is:

- CRTC and Video ULA set to MODE 2, SHEILA = &F4 
- ULA palette set to default (no flash) ??
- Single buffered with main memory paged in and displayed, so ACCON | 5 = 0
- Screen buffer may be garbage so set this up as required (most FX copying into buffer anyway)

Checkerboard
~~~
Options:
. Precompute checker pattern for 32x32 squares shifted by 1 pixel each
  . Set frame buffer address per scanline - allows wibble effect
  . Flip colours every 32 scanline using ULA flash bit
  . Flip colours when x offset > 32 in same way
  . Would sort out timing on scanline -1
  . Would implement decompress from SWRAM to screen buffer

. Draw black & white pixels into single scanline buffer as per Kefrens
  . No wibble as all scanlines will have to be vertically aligned
  . But could allow zoom at same time as scroll
  . Flip colours every N scanlines using ULA flash bit
  . MODE 4

Now generated byte spans for N pixels at offsets 0-7
X DIV N gives odd or even checker
X MOD N gives offset into checker
(X MOD N) MOD 8 gives which pixel offset table to use
(X MOD N) DIV 8 gives byte offset to start in data

For long lines
Always start with byte 0 so pixel offset of 0
Drawing >= 8 pixels
N - (X MOD N) is number of pixels to start with

18/4/2018
~~~
General raster ideas:
Logo with static: https://youtu.be/XJKDb4ByZ7Y?t=21s
Scrolltext per character row all at different speeds: https://youtu.be/XJKDb4ByZ7Y?t=41s
Interference by displaying circle pattern on alternate scanlines in different colours?
Bring logo/screens on in horizontal slices
VRUP screen into four & pulse on channel beats
Copper colour hue with ordered dither
- Don't forget horizontal dither in MODE 0 looks really nice
  could wibble & blend this between different colours

Twist:
Old venetian blind effect (vbars v8)
Silents bars: https://www.youtube.com/watch?v=l23miRWH5_Y&feature=youtu.be&t=7m2s

Vertical blinds
Start with 11 scanlines gone :S
Can go as high as 28 lines!  Music player registered 24 lines whilst script system 4 lines

Erase lines = 5 scanlines
Draw bars = 48 scanlines!!
Copy linear buffers to screen = 10 scanlines
= 63 scanlines total not including music
vblank = 56 scanlines all in

287 = VC=0 SC=1
288 = VC=1 SC=0

So effectively all FX update must be in 28 scanlines!

Options for vblinds
- Draw directly to screen buffer line - removes 10 scanline copy
  - Still need 5 scanlines to erase 2x lines of screen buffer
  - Optimise line drawing to take half the amount of time?! (Seems unlikely?)

- Or find a way to use the dead time inside the screen loop
  - Can draw to a different screen buffer and double buffer 1x row
  - How to make the bar drawing constant time inside the frame loop?

Proposal - DONE
- Draw bars to linear 8bpp frame buffer line during update (variable)
- Double buffer copy to screen during draw fn at constant time

LOOKS LIKE WE LOSE SYNC WHEN SWITCHING BETWEEN HIGH & LOW FREQUENCY UL
(understandably) - MEANS WE'LL HAVE TO STAY IN HIGH FREQUENCY MODE

Might make some FX harder, e.g. checkerboard (or use sparingly...?!)
Ideally would use MODE 1 and dither checks in different colours then 
switch between odd/even frame buffers on raster

Would need to draw 4x screen buffer lines in vblank as can't do work
in raster period since need to swap buffers often when N is small :\

In MODE 1, 80 cols x 4 = 320 bytes
Or do this in MODE 2 as simpler masking? Or even just do byte alignment
as vertical is going to be two row aligned? Might be able to blit these
out in different colours and set colours at raster time to isolate
individual boxes? - Put on the backlog!

Dither
4x4 ordered dither in 0 to 16, need 4 rows

Float
Float text up the screen with increasing ripples
Write small (8x8 or 16x8) font into the screen buffer spread across
8 character rows then move these up the screen from bottom to top,
repeating lines as necessary to stretch and bend the words
Can only (easily) have 32 char rows without resorting to SHADOW
Could then repeat some of the scanlines at the bottom as a mirror
(with colour change to blue or hatched blue)
MODE 2 or MODE 1?

Logo
Looks like Teletext but with a Twist :)
4x raster FX
- horizontal sinewave shift
- horizontal random shift "static"
- vertical line swap "glitch"
- vertical logo flip "spin"

RANDOM IDEA:
- Horizontal twist by having colours 1-15 in vertical strips across MODE 2 screen then set palette per scanline as appropriate: https://youtu.be/4Ma3X3YrtBE?t=3m4s
https://youtu.be/7maJ-ZaiAIo?t=43s

Simple text FX
- Plot static text with hatching 2x colours for fg & bg and animate palette: https://youtu.be/q53FIfd8r5Q?t=36s
Could turn the boxrot part into this to make it more interesting?
